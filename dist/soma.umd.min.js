/* soma - v3.0.4 - 31/12/2025 - https://github.com/soundstep/soma */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).soma={})}(this,function(t){"use strict";const e=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,i=/(?!function)\s*constructor\s*[^\(|function]*\(\s*([^\)]*)\)\s*{/m,n=/,/,s=/^\s*(_?)(\S+?)\1\s*$/,r=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,o={};o.errors={MAPPING_BAD_PROP:"[Error Injector.MAPPING_BAD_PROP] The first parameter is invalid, a string is expected.",MAPPING_BAD_VALUE:"[Error Injector.MAPPING_BAD_VALUE] The second parameter is invalid, it can't null or undefined, with property: ",MAPPING_BAD_CLASS:"[Error Injector.MAPPING_BAD_CLASS] The second parameter is invalid, a function is expected, with property: ",MAPPING_BAD_SINGLETON:"[Error Injector.MAPPING_BAD_SINGLETON] The third parameter is invalid, a boolean is expected, with property: ",MAPPING_ALREADY_EXISTS:"[Error Injector.MAPPING_ALREADY_EXISTS] This mapping already exists, with property: ",CREATE_INSTANCE_INVALID_PARAM:"[Error Injector.CREATE_INSTANCE_INVALID_PARAM] Invalid parameter, a function is expected.",NO_MAPPING_FOUND:"[Error Injector.NO_MAPPING_FOUND] No mapping found",INJECT_INSTANCE_IN_ITSELF_PROPERTY:"[Error Injector.INJECT_INSTANCE_IN_ITSELF_PROPERTY] A matching property `%p` has been found in the target, you can't inject an instance in itself.",INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR:"[Error Injector.INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR] A matching constructor parameter has been found in the target, you can't inject an instance in itself.",DEPENDENCIES_MISSING_IN_STRICT_MODE:'[Error Injector.DEPENDENCIES_MISSING_IN_STRICT_MODE] An "inject" property (array) that describes the dependencies is missing in strict mode.',DEPENDENCIES_MISSING_IN_STRICT_MODE_CONSTRUCTOR_INJECTION:'[Error Injector.DEPENDENCIES_MISSING_IN_STRICT_MODE_CONSTRUCTOR_INJECTION] An "inject" property (array) that describes the dependencies of constructor is missing in strict mode.',DEPENDENCIES_INVALID_TARGET:"[Error Injector.DEPENDENCIES_INVALID_TARGET] Invalid target, a function or a class is expected (arrow function cannot be instantiated)."};class c{constructor(t,e,i,n){this.prop=t,this.value=e,this.cl=i,this.singleton=n||!1,this.singletonPostConstructed=!1}}const a=t=>{if("string"!=typeof t)throw new Error(o.errors.MAPPING_BAD_PROP)},h=(t,e)=>{if(function(t,e){let i=t.length;for(;i--;)if(t[i]===e)return!0;return!1}(o.getDependencies(e),t))throw new Error(o.errors.INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR)},p=(t,e)=>{const i=void 0!==t?' for the injection name: "'+t+'"':"",n=void 0!==e?' when instantiating: "'+e+'"':"";return o.errors.NO_MAPPING_FOUND+i+n+"."};class l{constructor(){this.mappings={},this.parent=null,this.strictMode=!1,this.strictModeConstructorInjection=!1,this.throwOnMissing=!0}createChild(){const t=new l;return t.parent=this,t.strictMode=this.strictMode,t.strictModeConstructorInjection=this.strictModeConstructorInjection,t.throwOnMissing=this.throwOnMissing,t}getMappingVo(t){return this.mappings?this.mappings[t]?this.mappings[t]:this.parent?this.parent.getMappingVo(t):null:null}mapValue(t,e){if(this.mappings[t])throw new Error(o.errors.MAPPING_ALREADY_EXISTS+t);return a(t),((t,e)=>{if(null==e)throw new Error(o.errors.MAPPING_BAD_VALUE+t)})(t,e),this.mappings[t]=new c(t,e,null,!1),this}mapClass(t,e,i){if(this.mappings[t])throw new Error(o.errors.MAPPING_ALREADY_EXISTS+t+"  in "+(e.name??"n/a"));return a(t),((t,e)=>{if("function"!=typeof e)throw new Error(o.errors.MAPPING_BAD_CLASS+t)})(t,e),i&&((t,e)=>{if("boolean"!=typeof e)throw new Error(o.errors.MAPPING_BAD_SINGLETON+t)})(t,i),this.mappings[t]=new c(t,null,e,i||!1),this}removeMapping(t){return this.mappings[t]=null,delete this.mappings[t],this}hasMapping(t){return!!this.mappings[t]}hasInheritedMapping(t){return!!this.getMappingVo(t)}getMapping(t){for(const e in this.mappings)if(this.mappings.hasOwnProperty(e)){const i=this.mappings[e];if(i.value===t||i.cl===t)return i.prop}}getValue(t,...e){let i=this.mappings[t];if(!i){if(!this.parent){if(this.throwOnMissing)throw new Error(p(t));return}if(i=this.parent.getMappingVo(t),!i){if(this.throwOnMissing)throw new Error(p(t));return}}return i.cl?i.singleton?(i.value||(i.value=this.createInstance(i.cl,...e)),i.value):this.createInstance(i.cl,...e):i.value}getClass(t){const e=this.mappings[t];if(e){if(e.cl)return e.cl}else if(this.parent){const e=this.parent.getMappingVo(t);if(e&&e.cl)return e.cl}}instantiate(t,...e){if("function"!=typeof t)throw new Error(o.errors.CREATE_INSTANCE_INVALID_PARAM);const i=o.getDependencies(t);if(this.strictMode&&!t.hasOwnProperty("inject"))throw new Error(o.errors.DEPENDENCIES_MISSING_IN_STRICT_MODE+" : "+t.name+"("+i.join(", ")+")");if(this.strictModeConstructorInjection&&i.length>0&&!t.hasOwnProperty("inject"))throw new Error(o.errors.DEPENDENCIES_MISSING_IN_STRICT_MODE_CONSTRUCTOR_INJECTION+" : "+t.name+"("+i.join(", ")+")");const n=[null];for(let s=0,r=i.length;s<r;s++)if(e.length>s&&void 0!==e[s]&&null!==e[s])n.push(e[s]);else{const e=i[s],r=this.getMappingVo(e);if(r){const t=this.getInjectedValue(r,e);n.push(t)}else{if(this.throwOnMissing)throw new Error(p(e,t.name));n.push(void 0)}}return new(Function.prototype.bind.apply(t,n))}inject(t,e){this.parent&&this.parent.inject(t,!0),o.getExplicitInjectDependencies(t.constructor);for(const e in this.mappings)if(this.mappings.hasOwnProperty(e)){const i=this.mappings[e];i&&(t.hasOwnProperty(i.prop)||void 0!==t[i.prop]||t.constructor&&t.constructor.prototype&&t.constructor.prototype.hasOwnProperty(i.prop)||void 0!==t.constructor.inject&&t.constructor.inject.includes(i.prop))&&(t[e]=this.getInjectedValue(i,e))}return this}getInjectedValue(t,e){let i,n=t.value;return t.cl&&(t.singleton?(t.value||(h(e,t.cl),t.value=this.instantiate(t.cl),i=t.value),n=t.value):(h(e,t.cl),n=this.instantiate(t.cl),i=n)),i&&(((t,e)=>{if(e.hasOwnProperty(t))throw new Error(o.errors.INJECT_INSTANCE_IN_ITSELF_PROPERTY.replace("%p",t))})(e,i),this.inject(i),"function"==typeof i.postConstruct&&i.postConstruct()),n}createInstance(t,...e){const i=this.instantiate(t,...e);return this.inject(i),"function"==typeof i.postConstruct&&i.postConstruct(),i}getValueFromClass(t,...e){for(const i in this.mappings)if(this.mappings.hasOwnProperty(i)){const n=this.mappings[i];if(n.cl===t)return n.singleton?(n.value||(n.value=this.createInstance(t,...e)),n.value):this.createInstance(t,...e)}if(this.parent)return this.parent.getValueFromClass(t,...e);if(this.throwOnMissing)throw new Error(p(void 0,t.name))}dispose(){this.mappings={}}}o.getExplicitInjectDependencies=function(t){if(void 0!==t.inject&&"[object Array]"===Object.prototype.toString.call(t.inject)&&t.inject.length>0){return t.inject}return[]},o.getDependencies=function(t){const c=[];function a(t,e,i){c.push(i)}const h=o.getExplicitInjectDependencies(t),p=t.toString().replace(r,"");let l;if(0===p.indexOf("class"))l=p.replace(/function constructor/g,"").match(i);else{if(0!==p.indexOf("function"))throw new Error(o.errors.DEPENDENCIES_INVALID_TARGET);l=p.match(e)}if(l){const t=l[1].split(n);for(let e=0,i=t.length;e<i;e++){const i=t[e].split("=")[0].replace(/\s/g,"");(h&&h[e]?h[e]:i).replace(s,a)}}return c},Function.prototype.bind||(Function.prototype.bind=function(t,...e){const i=this;if("function"!=typeof i)throw new Error("Error, you must bind a function.");const n=e,s=function(...e){if(this instanceof s){const t=function(){};t.prototype=i.prototype;const s=new t,r=i.apply(s,n.concat(e));return Object(r)===r?r:s}return i.apply(t,n.concat(e))};return s});class u extends l{constructor(){super()}}var d="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var f=function(t){var e={exports:{}};return t(e,e.exports),e.exports}(function(t){!function(e){function i(t,e,i,n,s){this._listener=e,this._isOnce=i,this.context=n,this._signal=t,this._priority=s||0}function n(t,e){if("function"!=typeof t)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))}function s(){this._bindings=[],this._prevParams=null;var t=this;this.dispatch=function(){s.prototype.dispatch.apply(t,arguments)}}i.prototype={active:!0,params:null,execute:function(t){var e,i;return this.active&&this._listener&&(i=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,i),this._isOnce&&this.detach()),e},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},s.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(t,e,n,s){var r,o=this._indexOfListener(t,n);if(-1!==o){if((r=this._bindings[o]).isOnce()!==e)throw new Error("You cannot add"+(e?"":"Once")+"() then add"+(e?"Once":"")+"() the same listener without removing the relationship first.")}else r=new i(this,t,e,n,s),this._addBinding(r);return this.memorize&&this._prevParams&&r.execute(this._prevParams),r},_addBinding:function(t){var e=this._bindings.length;do{--e}while(this._bindings[e]&&t._priority<=this._bindings[e]._priority);this._bindings.splice(e+1,0,t)},_indexOfListener:function(t,e){for(var i,n=this._bindings.length;n--;)if((i=this._bindings[n])._listener===t&&i.context===e)return n;return-1},has:function(t,e){return-1!==this._indexOfListener(t,e)},add:function(t,e,i){return n(t,"add"),this._registerListener(t,!1,e,i)},addOnce:function(t,e,i){return n(t,"addOnce"),this._registerListener(t,!0,e,i)},remove:function(t,e){n(t,"remove");var i=this._indexOfListener(t,e);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),t},removeAll:function(){for(var t=this._bindings.length;t--;)this._bindings[t]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(t){if(this.active){var e,i=Array.prototype.slice.call(arguments),n=this._bindings.length;if(this.memorize&&(this._prevParams=i),n){e=this._bindings.slice(),this._shouldPropagate=!0;do{n--}while(e[n]&&this._shouldPropagate&&!1!==e[n].execute(i))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var r=s;r.Signal=s,t.exports?t.exports=r:e.signals=r}(d)});class g{constructor(){this.signals={}}addListener(t,e,i,n){return this.signals[t]||(this.signals[t]=new f.Signal),this.signals[t].add(e,i,n)}addListenerOnce(t,e,i,n){return this.signals[t]||(this.signals[t]=new f.Signal),this.signals[t].addOnce(e,i,n)}removeListener(t,e,i){const n=this.signals[t];n&&n.remove(e,i)}getSignal(t){return this.signals[t]}haltSignal(t){this.signals[t]&&this.signals[t].halt()}dispatch(t,e,i=!0){const n=this.signals[t];n&&(e?(i&&"[object Object]"===Object.prototype.toString.call(e)&&!e.hasOwnProperty("signalType")&&(e.signalType=t),n.dispatch.apply(n,[e])):n.dispatch())}dispose(){let t=this.signals;for(const e in t)t.hasOwnProperty(e)&&(t[e].removeAll(),delete t[e]);this.signals={}}}function _(t,e,i,n,s,...r){const o=t.createChild();o.mapValue("id",e),o.mapValue("signal",n),o.mapValue("binding",s);const c=o.createInstance(i);"function"==typeof c.execute&&c.execute.apply(c,r),o.dispose()}function m(t){return{setInjector:function(e){return t&&e&&(t.params[0]=e),m(t)}}}class E{constructor(t,e){this.list={},this.emitter=t,this.injector=e}add(t,e){if(this.list[t])throw new Error('[Commands] Error: a command with the id: "'+t+'" has already been registered');this.list[t]=e;const i=function(t,e,i){const n=t.emitter.addListener(e,_,t);return n.params=[t.injector,e,i,t.emitter.getSignal(e),n],n}(this,t,e);return m(i)}get(t){return this.list[t]}remove(t){this.list[t]&&(this.list[t]=void 0,delete this.list[t],function(t,e){const i=t.emitter.getSignal(e);i&&i.removeAll()}(this,t))}dispose(){for(const t in this.list)this.remove(t);this.list={},this.emitter=null,this.injector=void 0}}E.inject=["emitter","injector"];class I{constructor(){this.emitter=void 0,this.injector=void 0}create(t,e,i=!0){if(!this.injector)throw new Error("injector not present or has been disposed");if((n=e)&&"function"==typeof n.get&&"number"==typeof n.length){if(!e.length)return[];e=e.get()}var n;let s=[];const r=[];Array.isArray(e)&&e.length>0?s=[...e]:e instanceof HTMLElement?s=[e]:e instanceof NodeList&&(i?s=[e]:e.forEach(t=>{s.push(t)}));for(let e=0,i=s.length;e<i;e++){const i=this.injector.createChild();i.mapValue("target",s[e]);const n=i.createInstance(t);if(1===s.length)return n;r.push(n)}return r}dispose(){delete this.emitter,delete this.injector}}I.inject=["emitter","injector"];const y={};y.is={object:t=>"object"==typeof t&&null!==t,array:Array.isArray||(t=>"[object Array]"===Object.prototype.toString.call(t)),func:t=>"function"==typeof t},y.applyProperties=(t,e,i,n)=>{if("[object Array]"===Object.prototype.toString.apply(n))for(let s=0,r=n.length;s<r;s++)void 0!==t[n[s]]&&null!==t[n[s]]||(i&&"function"==typeof e[n[s]]?t[n[s]]=e[n[s]].bind(e):t[n[s]]=e[n[s]]);else for(const n in e)i&&"function"==typeof e[n]?t[n]=e[n].bind(e):t[n]=e[n]},y.augment=(t,e,i)=>{if(e.prototype&&t.prototype)if("[object Array]"===Object.prototype.toString.apply(i))for(let n=0,s=i.length;n<s;n++)t.prototype[i[n]]||(t.prototype[i[n]]=e.prototype[i[n]]);else for(const i in e.prototype)t.prototype[i]||(t.prototype[i]=e.prototype[i])},y.inherit=(t,e)=>{let i;i=e&&e.hasOwnProperty("constructor")?e.constructor:function(){return t.apply(this,arguments)};const n=function(){};return n.prototype=t.prototype,i.prototype=new n,e&&y.applyProperties(i.prototype,e),i.prototype.constructor=i,i.parent=t.prototype,i.extend=function(t){return y.inherit(i,t)},i},y.extend=t=>y.inherit(function(){},t);class N{constructor(t){this.injector=t,this.list={}}create(t,e,i,n){let s,r;const c=!1!==i,a=!0===n;if(y.is.func(t))r=t;else if(y.is.object(t)&&y.is.func(t.module))r=t.module;else{if(!y.is.object(t)||!y.is.func(t.Module))throw new Error("[Modules] Error: Could not create module. The module must be a function or an object containing a module property referencing a function.");r=t.Module}if(!(t=>{let e=!0;return(null==t||"string"!=typeof t.id)&&(e=!1),e})(r))throw new Error('[Modules] Error: Could not create module. The module function must contain a static "id" property, ex: function Module(){}; Module.id = "module-name"; ');if(r)if(this.has(r.id))s=this.get(r.id);else{let t=this.injector;a&&(t=this.injector.createChild(),t.mapValue("injector",t)),s=((t,e,i)=>{const n=o.getDependencies(e);let s=[e];for(let e=0,i=n.length;e<i;e++)t.hasMapping(n[e])||t.hasInheritedMapping(n[e])?s.push(t.getValue(n[e])):s.push(void 0);for(let t=s.length-1;t>=0&&void 0===s[t];t--)s.splice(t,1);i&&(s=s.concat(i));const[r,...c]=s;return t.createInstance(r,...c)})(t,r,e),h=this.list,p=r.id,l=s,!h[p]&&c&&(h[p]=l),"function"==typeof s.init&&s.init()}var h,p,l;return s}has(t){return void 0!==this.list[t]}get(t){return this.list[t]}remove(t){this.list[t]&&("function"==typeof this.list[t].dispose&&this.list[t].dispose(),this.list[t]=void 0,delete this.list[t])}dispose(){for(const t in this.list)this.remove(t);this.list={}}}N.inject=["injector"];t.Application=class{get emitter(){return this._emitter||new g}get injector(){return this._injector||new u}set commands(t){this._commands=t}get commands(){if(!this._commands)throw new Error("Commands not initialized. Call setup() first.");return this._commands}get mediators(){return this._mediators||new I}get modules(){if(!this._modules)throw new Error("Modules not initialized. Call setup() first.");return this._modules}constructor(){this.setup(),this.init(),this.initDone()}setupEmitter(){this._injector&&(this._injector.mapClass("emitter",g,!0),this._emitter=this._injector.getValue("emitter"))}setup(){this._injector=new u,this._injector.throwOnMissing=!1,this._injector.mapValue("injector",this._injector),this._injector.mapValue("instance",this),this.setupEmitter(),this._injector.mapClass("commands",E,!0),this._commands=this._injector.getValue("commands"),this._injector.mapClass("mediators",I,!0),this._mediators=this._injector.getValue("mediators"),this._injector.mapClass("modules",N,!0),this._modules=this._injector.getValue("modules")}init(){}initDone(){}dispose(){this._injector&&this._injector.dispose(),this.emitter&&this.emitter.dispose(),this._commands&&this._commands.dispose(),this._mediators&&this._mediators.dispose(),this._modules&&this._modules.dispose(),this._injector=void 0,this._emitter=void 0,this._commands=void 0,this._mediators=void 0,this._modules=void 0}},t.Commands=E,t.Emitter=g,t.Mediators=I,t.Modules=N,t.infuse=o,t.utils=y,Object.defineProperty(t,"__esModule",{value:!0})});
